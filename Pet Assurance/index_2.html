<!--飼主-->
<!DOCTYPE html>
<html lang="zh-tw">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>DApp_寵物</title>
        <link rel="icon" type="image/png" sizes="16x16" href="images/favicon.png" />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.13.1/css/OverlayScrollbars.min.css" />
    </head>

    <body class="sidebar-mini layout-fixed">
        <div class="wrapper">
            <div class="preloader flex-column justify-content-center align-items-center">
                <img class="animation__shake" src="images/favicon.png" alt="DApp_IFNFT" height="60" width="60" />
            </div>

            <nav class="main-header navbar navbar-expand navbar-white navbar-light">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
                    </li>
                </ul>
            </nav>

            <aside class="main-sidebar sidebar-dark-primary elevation-4">
                <a href="index_1.html" class="brand-link">
                    <img src="images/favicon.png" alt="DApp_寵物" class="brand-image img-circle elevation-3" style="opacity: 0.8" />
                    <span class="brand-text font-weight-light">DApp_寵物</span>
                </a>
                <div class="sidebar">
                    <nav class="mt-2">
                        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                            <li class="nav-item">
                                <a href="index_1.html" class="nav-link">
                                    <i class="nav-icon fas fa-file-alt"></i>
                                    <p>飼主</p>
                                </a>
                            </li>
                           
                            <li class="nav-item">
                                <a href="index_2.html" class="nav-link active">
                                    <i class="nav-icon fas fa-file-contract"></i>
                                    <p>醫院</p>
                                </a>
                            </li>                           
                            <li class="nav-item">
                                <a href="index_3.html" class="nav-link">
                                    <i class="nav-icon fas fa-images"></i>
                                    <p>保險公司</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="index_4.html" class="nav-link">
                                    <i class="nav-icon fas fa-images"></i>
                                    <p>查詢各項寵物資料</p>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </aside>

            <div class="content-wrapper">
                <div class="content-header">
                    <div class="container-fluid">
                        <div class="row mb-2">
                            <div class="col-12">
                                <h1 class="m-0">建立寵物醫療紀錄</h1>
                            </div>
                        </div>
                    </div>
                </div>

                <section class="content">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-12">
                                <div class="card card-primary">
                                    <div class="card-header">
                                        <h3 class="card-title">寵物理賠合約</h3>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <strong>合約位址</strong>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="contract_address" value=0x2Cc94F5B040653f6d1B31Fe6B91f793362a15485 />
                                            <div class="input-group-append">
                                                <button type="button" class="btn btn-danger" id="contract_address_btn">連結</button>
                                            </div>
                                        </div>
                                    </div>                                   
                                </div>
                            </div>
                        </div>
                        <div row="row">
                            <div class="col-12">
                                <div class="card card-primary">
                                    <div class="card-header">
                                        <strong>建立寵物醫療資料</strong>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                    </div>                                   
                                    <div class="card-body">                                                                                                                                                               
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="medical_id" placeholder=醫療ID />
                                        </div>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="medical_caseRecord" placeholder=案例紀錄 />
                                        </div>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="medical_doctor" placeholder=負責醫師 />
                                            <div class="input-group-append">
                                                <button type="button" class="btn btn-danger" id="contract_addRecordByID_btn">建立</button>
                                            </div> 
                                        </div>                                                                                                                                                                                                                                                                                                                                         
                                    </div>
                                </div>                                
                            </div>
                        </div>                                               
                    </div>
                </section>
            </div>

            <footer class="main-footer"></footer>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0-beta1/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.3/web3.min.js"></script>
        <script src="js/pet_ABI.js"></script>       
        <script src="js/pet_Contract.js"></script>
        
        <script>
            var web3;
            var pet_contract

            $(async function () {
                console.log("ethereum", window.ethereum);
                if (typeof window.ethereum !== "undefined") {
                    //檢查瀏覽器是否已安裝MetaMask
                    try {
                        //var accounts = await ethereum.enable(); //MetaMask請求用戶授權, 舊版的用法未來會停用
                        var accounts = await ethereum.request({ method: "eth_requestAccounts" }); //MetaMask請求用戶授權, 連結會登入到MetaMask
                        console.log("accounts", accounts);
    
                        //web3 = new Web3(web3.currentProvider);  //web3初始化, 設定Provider為MetaMask提供的Provider, 舊版的用法未來會停用
                        web3 = new Web3(window.ethereum); //web3初始化
    
                        updateWeb3Information();
                        updateWeb3Account(accounts[0]);
                    } catch (error) {
                        alert(error.message);
                    }
                } else {
                    alert("未安裝 MetaMask!");
                }
            });
    
            //MetaMask連結區塊鏈
            ethereum.on("connect", async function (connectInfo) {
                console.log("connect", connectInfo);
                let chain = "(" + connectInfo.chainId + ")" + getChainNameByID(connectInfo.chainId);
                $("#chain").val(chain);
            });
    
            //MetaMask切換網路
            ethereum.on("chainChanged", function (chainId) {
                console.log("chain id", chainId);
                window.location.reload();
            });
    
            //MetaMask切換帳戶
            ethereum.on("accountsChanged", function (accounts) {
                console.log("accountsChanged", accounts);
                updateWeb3Account(accounts[0]);
            });
    
            //根據Chain ID取得網路名稱
            function getChainNameByID(chainid) {
                switch (chainid) {
                    case "0x1":
                        return "Ethereum Main Network";
                    case "0x3":
                        return "Ropsten Test Network";
                    case "0x4":
                        return "Rinkeby Test Network";
                    case "0x5":
                        return "Goerli Test Network";
                    case "0x2a":
                        return "Kovan Test Network";
                    default:
                        return "Unknown Network";
                }
            }
    
            //更新web3資訊
            async function updateWeb3Information() {
                $("#web3_version").html(web3.version);
                console.log("providers", web3.providers);
                console.log("given provider", web3.givenProvider);
    
                var block_number = await web3.eth.getBlockNumber(); //查詢目前的區塊編號
                console.log("Block Number", block_number);
                $("#block_number").val(block_number);
            }
    
            //設定web3使用的帳戶
            async function updateWeb3Account(account) {
                web3.eth.defaultAccount = account; //設定web3使用的帳戶
                $("#account").html(account);
    
                var balance = await web3.eth.getBalance(web3.eth.defaultAccount); //查詢帳戶的以太幣餘額
                console.log("balance", balance);
                $("#balance").html(web3.utils.fromWei(balance, "ether") + " ETH");       
            }
    
            //連結合約
            $("#contract_address_btn").click(async function () {
                var contract_address = $("#contract_address").val();
                console.log("contract_address", contract_address);
                if (contract_address) {
                    contract = createContract(contract_address);
                    $("#contract_address").attr("readonly", true);
                    $("#contract_address_btn").attr("disabled", true);
                }
            });
    
            //建立智能合約實體
            async function createContract(address) {
                pet_contract = new web3.eth.Contract(pet_ABI, address, {
                    gasPrice: "20000000000", //以wei為單位的gas價格，設定為20 gwei
                });
                console.log("contract", pet_contract);                                    

                //修改寵物資料
                $('#contract_addRecordByID_btn').click(async function () {
                    var medical_id = $('#medical_id').val();
                    var medical_caseRecord = $('#medical_caseRecord').val();
                    var medical_doctor = $('#medical_doctor').val();                   
                    console.log('medical_id', medical_id);
                    console.log('medical_caseRecord', medical_caseRecord);
                    console.log('medical_doctor', medical_doctor);                   
                    
                    if(pet_contract){
                        try{
                            await pet_contract.methods.addRecordByID(medical_id, medical_caseRecord, medical_doctor).send({from: web3.eth.defaultAccount, gas:1000000});
                        }
                        catch(error){
                            console.log(error);
                            alert("無法建立寵物醫療資料");
                        }
                    }
                });
            }
        </script>
    </body>
</html>
