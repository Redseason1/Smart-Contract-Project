<!--買賣二手票-->
<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
    <title>演唱會售票系統</title>
    <link rel="icon" type="image/png" sizes="16x16" href="https://offers.applemusic.apple/assets/dd21ce2fa8811aa40c8c778adff36fa816e0c2bd-en-us-large@1x.png" />

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css" />
</head>

<body class="hold-transition layout-top-nav">
    <div class="wrapper">
        <nav class="main-header navbar navbar-expand-md navbar-light navbar-white">
            <div class="container">
                <a href="index_1.html" class="navbar-brand">
                    <img src="https://offers.applemusic.apple/assets/dd21ce2fa8811aa40c8c778adff36fa816e0c2bd-en-us-large@1x.png" alt="售票系統" class="brand-image img-circle elevation-3" style="opacity: 1">
                    <span class="brand-text font-weight-bold">演唱會售票系統</span>
                </a>
                <button class="navbar-toggler order-1" type="button" data-toggle="collapse"
                    data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse order-3 collapse show" id="navbarCollapse">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a href="index_1.html" class="nav-link">首頁</a>
                        </li>
                        <li class="nav-item">
                            <a href="index_2.html" class="nav-link">購買門票</a>
                        </li>
                        <li class="nav-item">
                            <a href="index_3.html" class="nav-link active">買賣二手票</a>
                        </li>
                    </ul>
                    <form class="form-inline ml-0 ml-md-3">
                        <div class="input-group input-group-sm">
                            <input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
                            <div class="input-group-append">
                                <button class="btn btn-navbar" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <ul class="order-1 order-md-3 navbar-nav navbar-no-expand ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index_4.html" role="button">
                            <i class="fa fa-user-tie"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="content-wrapper">
            <div class="content-header">
                <div class="container">
                    <div class="row mb-2">
                        <div class="col-12">
                            <h1 class="m-0"> 買賣演唱會二手門票</h1>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content">
                <div class="container">
                    <div class="row">
                        <div class="col-12">
                            <div class="card card-primary">
                                <div class="card-header">
                                    <h3 class="card-title">售票系統合約</h3>
                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <strong>售票系統合約位址</strong>
                                            <div class="input-group mb-3">
                                                <input type="text" class="form-control" id="contract_address" value="0x5fD763E4614988295742767c83838c25d7Ecd74f" />
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-warning" id="contract_address_btn">連結合約</button>
                                                </div>
                                            </div>                                                
                                        </div>                                           
                                    </div>
                                </div>
                            </div>                                                              
                        </div>
                        <div class="col-lg-12 col-12">
                            <div class="small-box bg-gradient-info" >
                                <div class="inner" style="word-break: break-word">
                                    <h3 id="contract_ticketstateOf" style="white-space: normal;"></h3>
                                    <p>掛賣中的二手門票</p>
                                </div>
                                <div class="icon">
                                    <i class="fa fa-ticket"></i>
                                </div>
                            </div>
                        </div>  
                        <div class="col-lg-6 col-12">
                            <div class="small-box bg-gradient-info" >
                                <div class="inner">
                                    <div class="col-12">
                                        <strong>購買二手門票</strong>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="ticket_numberOfbuy" placeholder="掛賣中的二手門票編號">
                                            <div class="input-group-append">
                                                <button type="button" class="btn btn-danger" id="contract_buysecondticket_btn">購買</button>
                                            </div>
                                        </div>
                                    </div>                                          
                                </div> 
                            </div>
                        </div>
                        <div class="col-lg-6 col-12">
                            <div class="small-box bg-gradient-olive" >
                                <div class="inner">
                                    <div class="col-12">
                                        <strong>掛賣二手門票</strong>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="ticket_number" placeholder="您持有的門票編號">         
                                        </div> 
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="ticket_price" placeholder="欲掛賣的門票價格(上限500 Tokens)">
                                            <div class="input-group-append">
                                                <button type="button" class="btn btn-danger" id="contract_sellticket_btn">掛賣</button>
                                            </div>
                                        </div>                                                       
                                    </div>                                                                                                                
                                </div>             
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content-header">
                <div class="container">
                    <div class="row mb-2">
                        <div class="col-12">
                            <h1 class="m-0"> 您的帳戶資訊</h1>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12 col-12">
                            <div class="small-box bg-gradient-warning">
                                <div class="inner" style="word-break: break-word">
                                    <h3 id="account" style="white-space: normal;"></h3>
                                    <p>您的帳戶位址</p>
                                </div>
                                <div class="icon">
                                    <i class="fa fa-location-dot"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-12 col-12">
                            <div class="small-box bg-gradient-warning">
                                <div class="inner" style="word-break: break-word">
                                    <h3 id="balance" style="white-space: normal;"></h3>
                                    <p>您的以太幣餘額</p>
                                </div>
                                <div class="icon">
                                    <i class="fa fa-wallet"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-12">
                            <div class="small-box bg-gradient-olive">
                                <div class="inner">
                                    <h3 id="contract_balanceOf"></h3>
                                    <p>您的Token餘額</p>
                                </div>
                                <div class="icon">
                                    <i class="fa fa-coins"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-12">
                            <div class="small-box bg-gradient-olive">
                                <div class="inner">
                                    <h3 id="contract_tickethold"></h3>
                                    <p>您持有的門票</p>
                                </div>
                                <div class="icon">
                                    <i class="fa fa-ticket"></i>
                                </div>
                            </div>
                        </div>                        
                    </div>
                </div>
            </div>
        </div>

        <footer class="main-footer">
            <div class="float-right d-none d-sm-inline">智能合約撰寫 期末報告 第六組</div>
            <strong>Copyright &copy; 2014-2021 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved.
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0-beta1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.3/web3.min.js"></script>
    <script src="js/TicketPlatform_ABI.js"></script>
    <script src="js/TicketPlatform_Contract.js"></script>

    <script>
        var web3;
        var TicketPlatform_Contract;
        $(async function () {
            console.log("ethereum", window.ethereum);
            if (typeof window.ethereum !== "undefined") {
                //檢查瀏覽器是否已安裝MetaMask
                try {
                    //var accounts = await ethereum.enable(); //MetaMask請求用戶授權, 舊版的用法未來會停用
                    var accounts = await ethereum.request({
                        method: "eth_requestAccounts",
                    }); //MetaMask請求用戶授權, 連結會登入到MetaMask
                    console.log("accounts", accounts);

                    //web3 = new Web3(web3.currentProvider);  //web3初始化, 設定Provider為MetaMask提供的Provider, 舊版的用法未來會停用
                    web3 = new Web3(window.ethereum); //web3初始化

                    updateWeb3Information();
                    updateWeb3Account(accounts[0]);
                } catch (error) {
                    alert(error.message);
                }
            } else {
                alert("未安裝 MetaMask!");
            }
        });

        //MetaMask連結區塊鏈
        ethereum.on("connect", async function (connectInfo) {
            console.log("connect", connectInfo);
            let chain = "(" + connectInfo.chainId + ")" + getChainNameByID(connectInfo.chainId);
            $("#chain").val(chain);
        });

        //MetaMask切換網路
        ethereum.on("chainChanged", function (chainId) {
            console.log("chain id", chainId);
            window.location.reload();
        });

        //MetaMask切換帳戶
        ethereum.on("accountsChanged", function (accounts) {
            console.log("accountsChanged", accounts);
            updateWeb3Account(accounts[0]);
        });

        //根據Chain ID取得網路名稱
        function getChainNameByID(chainid) {
            switch (chainid) {
                case "0x1":
                    return "Ethereum Main Network";
                case "0x3":
                    return "Ropsten Test Network";
                case "0x4":
                    return "Rinkeby Test Network";
                case "0x5":
                    return "Goerli Test Network";
                case "0x2a":
                    return "Kovan Test Network";
                default:
                    return "Unknown Network";
            }
        }

        //更新web3資訊
        async function updateWeb3Information() {
            $("#web3_version").html(web3.version);
            console.log("providers", web3.providers);
            console.log("given provider", web3.givenProvider);

            var block_number = await web3.eth.getBlockNumber(); //查詢目前的區塊編號
            console.log("Block Number", block_number);
            $("#block_number").val(block_number);
        }

        //設定web3使用的帳戶
        async function updateWeb3Account(account) {
            web3.eth.defaultAccount = account; //設定web3使用的帳戶
            $("#account").html(account);

            var balance = await web3.eth.getBalance(web3.eth.defaultAccount); //查詢帳戶的以太幣餘額
            console.log("balance", balance);
            $("#balance").html(web3.utils.fromWei(balance, "ether") + " ETH");
        }

        //連結合約
        $("#contract_address_btn").click(async function () {
            var contract_address = $("#contract_address").val();
            console.log("contract_address", contract_address);
            if (contract_address) {
                contract = createContract(contract_address);
                $("#contract_address").attr("readonly", true);
                $("#contract_address_btn").attr("disabled", true);
            }
        });

        //建立智能合約實體
        async function createContract(address) {
            TicketPlatform_Contract = new web3.eth.Contract(TicketPlatform_ABI, address, {
                gasPrice: "20000000000", //以wei為單位的gas價格，設定為20 gwei
            });
            console.log("contract", TicketPlatform_Contract);

            if (TicketPlatform_Contract){
                //查詢掛賣中的二手票
                var tickets_state = await contract_ticketstateOf(TicketPlatform_Contract);
                console.log("contract_ticketstateOf", tickets_state);
                console.log(typeof(tickets_state));
                $("#contract_ticketstateOf").html(tickets_state);

                //查詢代幣餘額
                var balances = await contract_balanceOf(TicketPlatform_Contract);
                console.log("contract_balanceOf", balances);
                $("#contract_balanceOf").html(balances + " Tokens");

                //查詢持有票券
                var tickets = await contract_tickethold(TicketPlatform_Contract);
                console.log("contract_tickethold", tickets);
                $("#contract_tickethold").html(tickets);
                             
                //掛賣二手票
                $("#contract_sellticket_btn").click(async function () {
                    var ticket_number = $("#ticket_number").val();
                    var ticket_price = $("#ticket_price").val();
                    console.log("ticket_number", ticket_number);
                    console.log("ticket_price", ticket_price);
                    if (ticket_number && ticket_price) { 
                        $("#ticket_number").attr("readonly", true);
                        $("#ticket_price").attr("readonly", true);
                        
                        try{                                
                            TicketPlatform_Contract.methods.sellticket_8(ticket_number, ticket_price).send({from: web3.eth.defaultAccount, gas:1000000});                                
                        }catch(error){
                            console.log(error);
                            alert("執行sellticket失敗");
                        }                            
                    }
                });

                //購買二手票
                $("#contract_buysecondticket_btn").click(async function () {
                    var ticket_numberOfbuy = $("#ticket_numberOfbuy").val();
                    console.log("ticket_numberOfbuy", ticket_numberOfbuy);
                    if (ticket_numberOfbuy) {                           
                        $("#ticket_numberOfbuy").attr("readonly", true);

                        try{                                
                            TicketPlatform_Contract.methods.buysecondticket_10(ticket_numberOfbuy).send({from: web3.eth.defaultAccount, gas:1000000});                                
                        }catch(error){
                            console.log(error);
                            alert("執行buysecondticket失敗");
                        }
                    }
                });
            }                
        }                       
    </script>
</body>
</html>